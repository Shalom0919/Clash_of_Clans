# 账号删除功能说明

## 功能概述

在账号选择界面（登录场景）添加了**删除账号**功能，允许用户删除不需要的账号及其所有相关数据。

## 主要特性

### 1. 删除按钮位置
- 每个账号项右侧显示 **???** 删除按钮
- 位于选中标记（?）旁边
- 醒目但不突兀的设计

### 2. 删除确认机制
- 点击删除按钮后弹出确认对话框
- 显示警告信息，防止误操作
- 明确提示"此操作不可恢复"

### 3. 数据清理
- 删除账号信息
- 删除游戏数据文件（`gamedata_*.json`）
- 自动调整活动账号索引

## 技术实现

### 修改的文件

#### 1. **AccountManager.h**
添加了删除账号的方法声明：

```cpp
// Delete an account by userId. Returns true if successful.
bool deleteAccount(const std::string& userId);
```

#### 2. **AccountManager.cpp**
实现了 `deleteAccount()` 方法：

**核心逻辑：**
1. 查找要删除的账号
2. 检查是否是当前登录账号
3. 删除游戏数据文件
4. 从账号列表中移除
5. 调整活动账号索引
6. 保存更新后的账号列表

**关键代码：**
```cpp
bool AccountManager::deleteAccount(const std::string& userId)
{
    // 1. 查找账号
    auto it = std::find_if(_accounts.begin(), _accounts.end(), 
        [&userId](const AccountInfo& acc) { return acc.userId == userId; });
    
    if (it == _accounts.end())
        return false;
    
    // 2. 检查是否是当前账号
    int indexToDelete = static_cast<int>(std::distance(_accounts.begin(), it));
    bool isDeletingCurrentAccount = (indexToDelete == _activeIndex);
    
    // 3. 删除游戏数据文件
    std::string filePath = getGameDataFilePath(userId);
    if (FileUtils::getInstance()->isFileExist(filePath))
    {
        FileUtils::getInstance()->removeFile(filePath);
    }
    
    // 4. 从列表移除
    _accounts.erase(it);
    
    // 5. 调整索引
    if (isDeletingCurrentAccount)
    {
        _activeIndex = -1;
    }
    else if (_activeIndex > indexToDelete)
    {
        _activeIndex--;
    }
    
    // 6. 保存
    save();
    
    return true;
}
```

#### 3. **AccountSelectScene.h**
添加了删除确认对话框的方法声明：

```cpp
void showDeleteConfirmDialog(const std::string& userId, const std::string& username);
```

#### 4. **AccountSelectScene.cpp**

##### ① 在账号列表项中添加删除按钮

```cpp
// 删除按钮（红色垃圾桶图标）
auto deleteBtn = Button::create();
deleteBtn->setTitleText("???");
deleteBtn->setTitleFontSize(28);
deleteBtn->setContentSize(Size(50, 50));
deleteBtn->setPosition(Vec2(750, 40));
deleteBtn->addClickEventListener([this, a](Ref*) {
    showDeleteConfirmDialog(a.userId, a.username);
});
item->addChild(deleteBtn);
```

##### ② 实现删除确认对话框

**UI元素：**
- 半透明背景遮罩
- 警告图标（??）
- 红色标题："确认删除账号"
- 账号信息显示
- 警告文本："此操作不可恢复！"
- 详细说明："账号的所有数据将被永久删除"
- 红色"确认删除"按钮
- 灰色"取消"按钮

**删除逻辑：**
```cpp
auto& mgr = AccountManager::getInstance();

if (mgr.deleteAccount(userId))
{
    // 如果删除的是当前选中的账号，清除选中状态
    if (_selectedUserId == userId)
    {
        _selectedUserId.clear();
    }
    
    // 刷新列表
    refreshList();
    
    // 显示成功提示
    // ...
}
```

## 用户体验流程

### 删除账号流程
```
1. 账号选择界面
   ↓
2. 点击账号右侧的 ??? 删除按钮
   ↓
3. 弹出确认对话框
   - 显示警告图标 ??
   - 显示账号名称
   - 提示"此操作不可恢复！"
   - 提示"账号的所有数据将被永久删除"
   ↓
4a. 点击"确认删除"（红色按钮）
    → 删除账号和数据
    → 刷新账号列表
    → 显示成功提示："账号 'xxx' 已删除"
    
4b. 点击"取消"（灰色按钮）
    → 关闭对话框
    → 不做任何操作
```

## 界面设计

### 账号列表项布局

```
┌─────────────────────────────────────────────────────┐
│  玩家1 (local-123456789)              ?       ???  │
│  (选中时背景高亮)                    (选中)  (删除) │
└─────────────────────────────────────────────────────┘
```

### 删除确认对话框

```
┌──────────────────────────────────────────┐
│                   ??                      │
│           确认删除账号 (红色)             │
│                                           │
│          账号: 玩家1                      │
│                                           │
│       此操作不可恢复！(红色)              │
│    账号的所有数据将被永久删除 (灰色)      │
│                                           │
│  ┌─────────────┐    ┌─────────┐          │
│  │ 确认删除    │    │  取消   │          │
│  │  (红色)     │    │ (灰色)  │          │
│  └─────────────┘    └─────────┘          │
└──────────────────────────────────────────┘
```

## 安全机制

### 1. 二次确认
- 点击删除按钮后不会立即删除
- 必须在确认对话框中再次点击"确认删除"

### 2. 明确警告
- 使用醒目的警告图标 ??
- 红色文字提示"此操作不可恢复！"
- 清晰说明将删除所有数据

### 3. 视觉区分
- 确认删除按钮使用红色背景
- 与普通按钮明显区分
- 降低误操作风险

### 4. 索引自动调整
- 删除账号后自动调整活动账号索引
- 防止索引越界
- 如果删除的是当前账号，清除活动状态

## 数据清理范围

### 删除操作会清除：
1. **账号信息**
   - 用户ID
   - 用户名
   - 密码
   - 分配的地图
   - 游戏数据引用

2. **游戏数据文件**
   - 文件路径：`getWritablePath() + "gamedata_" + userId + ".json"`
   - 包含：
     - 资源数据（金币、圣水、宝石）
     - 建筑数据（位置、等级）
     - 容量数据
     - 大本营等级

3. **索引调整**
   - 如果删除的是当前账号：`_activeIndex = -1`
   - 如果活动账号在删除账号之后：`_activeIndex--`

## 注意事项

### 1. 不可恢复
- 账号删除后无法恢复
- 所有游戏进度永久丢失
- 建议用户谨慎操作

### 2. 本地数据
- 当前实现仅删除本地数据
- 如果未来接入服务器，需要同步删除服务器数据

### 3. 最后一个账号
- 允许删除所有账号
- 删除最后一个账号后列表为空
- 界面会显示"暂无账号，请点击新增账号"

## 代码示例

### 调用删除账号
```cpp
auto& mgr = AccountManager::getInstance();
bool success = mgr.deleteAccount("local-123456789");

if (success)
{
    CCLOG("? Account deleted successfully");
}
else
{
    CCLOG("? Failed to delete account");
}
```

### 检查账号是否存在
```cpp
const auto& accounts = mgr.listAccounts();
auto it = std::find_if(accounts.begin(), accounts.end(),
    [&userId](const AccountInfo& acc) { 
        return acc.userId == userId; 
    });

bool exists = (it != accounts.end());
```

## 测试清单

- [x] 删除按钮正常显示
- [x] 点击删除按钮弹出确认对话框
- [x] 确认对话框显示正确的账号信息
- [x] 警告信息清晰可见
- [x] 点击"确认删除"成功删除账号
- [x] 点击"取消"关闭对话框且不删除
- [x] 删除后账号列表正确刷新
- [x] 删除游戏数据文件成功
- [x] 删除当前选中的账号后清除选中状态
- [x] 删除当前登录的账号后索引正确调整
- [x] 删除最后一个账号后界面正常
- [x] 成功提示正确显示
- [x] 编译无错误

## 后续优化建议

### 1. 密码验证
- 删除账号前要求输入密码验证
- 增强安全性

### 2. 批量删除
- 支持选择多个账号批量删除
- 提高操作效率

### 3. 账号回收站
- 删除的账号进入回收站
- 30天内可恢复
- 过期后永久删除

### 4. 云端同步
- 支持云端账号管理
- 删除本地账号时同步删除云端数据

### 5. 删除原因
- 添加删除原因选项
- 收集用户反馈
- 优化产品体验

---

**文档版本：** 1.0  
**创建日期：** 2024年  
**最后更新：** 2024年  
**维护人：** Development Team
