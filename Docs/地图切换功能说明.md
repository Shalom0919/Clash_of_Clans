# 地图切换功能说明

## 功能概述

本次更新为游戏添加了**动态地图切换**功能，允许每个账号选择并保存自己专属的地图配置。

## 主要特性

### 1. 账号专属地图
- 每个账号可以独立选择使用的地图（Map1/Map2/Map3）
- 地图选择会自动保存到账号信息中
- 切换账号时会自动加载该账号对应的地图

### 2. 设置面板集成
- 在游戏设置面板中添加了 **"??? 切换地图"** 按钮
- 提供友好的地图选择界面，显示：
  - 地图名称（地图1/2/3）
  - 地图描述（经典草原/沙漠荒野/雪地冰原）
  - 当前使用的地图会高亮显示

### 3. 即时生效机制
- 选择新地图后会自动保存账号配置
- 提示用户"地图已切换！请重新进入游戏生效"
- 支持场景重新加载以应用新地图

## 技术实现

### 修改的文件

#### 1. **AccountManager.h/cpp**
- ? 在 `AccountInfo` 结构中已有 `assignedMapName` 字段
- ? 序列化和反序列化时保存/读取地图配置
- ? 新账号创建时随机分配地图

#### 2. **SettingsPanel.h/cpp**
- ? 新增 `_mapSwitchButton` 按钮
- ? 新增 `onMapSwitchClicked()` 方法
- ? 新增 `showMapSelectionPanel()` 方法显示地图选择界面
- ? 新增 `_onMapChanged` 回调，通知场景地图已更改

#### 3. **SceneUIController.h/cpp**
- ? 新增 `MapChangedCallback` 类型定义
- ? 新增 `setOnMapChanged()` 回调设置方法
- ? 在 `onSettingsClicked()` 中设置地图切换回调

#### 4. **DraggableMapScene.h/cpp**
- ? 在 `initializeManagers()` 中使用账号的 `assignedMapName` 加载地图
- ? 在 `setupCallbacks()` 中绑定地图切换回调
- ? 新增 `onMapChanged()` 方法处理地图切换

## 使用方法

### 用户操作流程

1. **打开设置面板**
   - 点击游戏右上角的 ? 齿轮按钮

2. **选择地图**
   - 点击 "??? 切换地图" 按钮
   - 在弹出的地图选择面板中选择心仪的地图：
     - 地图 1 - 经典草原地图
     - 地图 2 - 沙漠荒野地图
     - 地图 3 - 雪地冰原地图

3. **确认切换**
   - 点击非当前地图项
   - 系统自动保存选择
   - 显示提示："地图已切换！请重新进入游戏生效"

4. **重新加载**
   - 场景自动重新加载
   - 建筑布局保留
   - 新地图背景应用成功

### 注意事项

- ? 地图切换不会影响建筑布局和资源
- ? 每个账号的地图选择独立保存
- ? 切换账号时会自动加载对应账号的地图
- ? 新建账号会随机分配三张地图中的一张

## 数据存储

### 存储位置
- 账号信息：`accounts.xml`（由 `StorageManager` 管理）
- 字段名称：`assignedMapName`
- 默认值：`"map/Map1.png"`

### 数据格式示例
```xml
<account>
    <userId>user_123</userId>
    <username>玩家1</username>
    <assignedMapName>map/Map2.png</assignedMapName>
    <!-- 其他字段... -->
</account>
```

## 地图配置

### 可用地图列表
| 地图ID | 文件路径 | 显示名称 | 描述 |
|--------|----------|----------|------|
| 1 | `map/Map1.png` | 地图 1 | 经典草原地图 |
| 2 | `map/Map2.png` | 地图 2 | 沙漠荒野地图 |
| 3 | `map/Map3.png` | 地图 3 | 雪地冰原地图 |

### 地图参数（MapController）
```cpp
_mapConfigs["map/Map1.png"] = {1.3f, Vec2(1406.0f, 2107.2f), 55.6f};
_mapConfigs["map/Map2.png"] = {1.3f, Vec2(1402.0f, 2097.2f), 56.1f};
_mapConfigs["map/Map3.png"] = {1.3f, Vec2(1403.0f, 2075.2f), 54.9f};
```

## 扩展性

### 添加新地图的步骤

1. **准备地图资源**
   - 将新地图图片放入 `Resources/map/` 目录
   - 命名为 `Map4.png`（或其他名称）

2. **更新地图配置**
   - 在 `MapController::init()` 中添加配置：
     ```cpp
     _mapConfigs["map/Map4.png"] = {1.3f, Vec2(x, y), tileSize};
     ```

3. **更新选择面板**
   - 在 `SettingsPanel::showMapSelectionPanel()` 中添加选项：
     ```cpp
     {"地图 4", "map/Map4.png", "新地图描述"}
     ```

4. **测试**
   - 验证地图加载正常
   - 验证网格对齐正确
   - 验证建筑放置无误

## 测试清单

- [x] 地图切换按钮正常显示
- [x] 地图选择面板正常弹出
- [x] 当前地图高亮显示
- [x] 选择新地图后保存成功
- [x] 场景重新加载应用新地图
- [x] 建筑布局不受影响
- [x] 账号切换时加载正确地图
- [x] 新账号创建时随机分配地图
- [x] 编译无错误

## 已知限制

1. **需要重新进入场景**
   - 当前实现需要场景重载才能应用新地图
   - 未来可优化为热切换（不重载场景）

2. **地图数量固定**
   - 当前支持3张地图
   - 添加新地图需要修改代码

## 未来改进方向

1. **热切换地图**
   - 实现不重载场景的地图切换
   - 平滑过渡动画

2. **地图预览**
   - 在选择界面显示地图缩略图
   - 更直观的地图展示

3. **配置文件驱动**
   - 将地图列表移至配置文件
   - 支持运行时添加新地图

4. **地图主题系统**
   - 不同地图应用不同的UI主题
   - 匹配地图风格的建筑皮肤

---

**文档版本：** 1.0  
**创建日期：** 2024年  
**最后更新：** 2024年  
**维护人：** Development Team
