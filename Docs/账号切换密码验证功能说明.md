# 账号切换密码验证功能说明

## 问题描述

之前在游戏设置面板中切换账号时，没有要求输入密码验证，这与登录场景的逻辑不一致，存在安全隐患。

## 解决方案

为 `SettingsPanel` 添加密码验证功能，确保切换账号时需要输入目标账号的密码。

## 技术实现

### 修改的文件

#### 1. **SettingsPanel.cpp**

##### ① 修改账号点击逻辑
```cpp
// 原代码（无密码验证）
itemLayout->addClickEventListener([this, account, accountPanel](Ref*) {
    // 直接保存账号ID并切换
    UserDefault::getInstance()->setStringForKey("switching_to_account", account.userId);
    _onAccountSwitched();
});

// 新代码（添加密码验证）
itemLayout->addClickEventListener([this, account, accountPanel](Ref*) {
    // 关闭账号选择面板
    accountPanel->removeFromParent();
    
    // 显示密码验证对话框
    showPasswordDialog(account.userId, account.username);
});
```

##### ② 新增 `showPasswordDialog()` 方法

**功能：**
- 创建半透明背景遮罩
- 显示密码输入框
- 提供确认/取消按钮
- 验证密码正确性
- 显示错误提示和动画

**实现要点：**

1. **UI布局**
   ```cpp
   - 遮罩层（半透明黑色）
   - 对话框背景（深色）
   - 标题：显示目标账号名称
   - 密码输入框（密文模式）
   - 错误提示标签（初始隐藏）
   - 确认/取消按钮
   ```

2. **密码验证逻辑**
   ```cpp
   auto& accMgr = AccountManager::getInstance();
   if (accMgr.verifyPassword(userId, password))
   {
       // 密码正确 -> 切换账号
   }
   else
   {
       // 密码错误 -> 显示错误提示 + 播放抖动动画
   }
   ```

3. **错误处理**
   - **密码为空**：提示"密码不能为空！"
   - **密码错误**：提示"密码错误！请重试"
   - 错误时播放抖动动画并清空输入框

4. **动画效果**
   - 对话框弹出：`EaseBackOut` 缩放动画
   - 密码错误：左右抖动动画

#### 2. **SettingsPanel.h**

添加方法声明：
```cpp
void showPasswordDialog(const std::string& userId, const std::string& username);
```

## 用户体验流程

### 原流程（无密码验证）
```
1. 点击设置 ?
2. 点击"切换账号"
3. 选择目标账号
4. ? 直接切换（安全隐患）
```

### 新流程（带密码验证）?
```
1. 点击设置 ?
2. 点击"切换账号"
3. 选择目标账号
4. ?? 弹出密码输入框
5. 输入密码
   - ? 密码正确 → 切换账号并重新加载场景
   - ? 密码错误 → 显示错误提示，重新输入
6. 或点击"取消"返回
```

## 界面设计

### 密码验证对话框

```
┌─────────────────────────────────────┐
│  切换到账号: 玩家1                    X │
│  请输入密码                            │
│                                        │
│  ┌──────────────────────┐              │
│  │ ********             │ (密码输入框) │
│  └──────────────────────┘              │
│                                        │
│  密码错误！请重试 (错误提示，红色)     │
│                                        │
│  ┌──────┐    ┌──────┐                 │
│  │ 确认 │    │ 取消 │                 │
│  └──────┘    └──────┘                 │
└─────────────────────────────────────┘
```

## 安全特性

### 1. 密码保护
- ? 切换账号需要验证目标账号密码
- ? 密码输入框使用密文模式（显示为 `*`）
- ? 验证失败会清空输入框，防止窥探

### 2. 验证逻辑
- 使用 `AccountManager::verifyPassword()` 方法
- 与登录场景保持一致的验证逻辑

### 3. 用户反馈
- 空密码提示
- 错误密码提示
- 抖动动画增强错误感知

## 代码对比

### 登录场景（AccountSelectScene）
```cpp
// 已有密码验证功能
void AccountSelectScene::showPasswordDialog(const std::string& userId)
{
    // 密码验证逻辑
    if (mgr.verifyPassword(userId, password))
    {
        mgr.switchAccount(userId);
        // 进入游戏
    }
}
```

### 设置面板（SettingsPanel）
```cpp
// 新增密码验证功能（与登录场景保持一致）
void SettingsPanel::showPasswordDialog(const std::string& userId, const std::string& username)
{
    // 密码验证逻辑
    if (accMgr.verifyPassword(userId, password))
    {
        // 触发账号切换回调
        if (_onAccountSwitched) { _onAccountSwitched(); }
    }
}
```

## 注意事项

### 1. 回调流程
```
SettingsPanel::showPasswordDialog()
    ↓
验证密码成功
    ↓
_onAccountSwitched() 回调
    ↓
SceneUIController::onSettingsClicked()
    ↓
DraggableMapScene::onAccountSwitched()
    ↓
保存当前账号状态
    ↓
切换账号（AccountManager::switchAccount）
    ↓
重新创建场景（replaceScene）
```

### 2. 数据安全
- 密码临时存储在 `UserDefault` 的 `"switching_to_account"` 键中
- 切换完成后会清除此临时数据
- 密码验证前不会实际切换账号

### 3. 与登录场景的差异
| 特性 | 登录场景 | 设置面板 |
|------|----------|----------|
| 显示账号列表 | ? | ? |
| 密码验证 | ? | ?（新增）|
| 创建新账号 | ? | ? |
| 场景切换 | 进入游戏 | 重新加载场景 |

## 测试清单

- [x] 点击"切换账号"显示账号列表
- [x] 当前账号显示"(当前)"标识
- [x] 点击其他账号弹出密码输入框
- [x] 空密码提示正确显示
- [x] 密码错误提示正确显示
- [x] 密码错误时播放抖动动画
- [x] 密码正确后成功切换账号
- [x] 取消按钮正常关闭对话框
- [x] 密码输入框为密文模式
- [x] 场景重新加载后数据正确
- [x] 编译无错误

## 后续优化建议

### 1. 密码加密
- 当前密码以明文存储，建议使用哈希算法（如 SHA-256）
- 修改 `AccountManager::verifyPassword()` 为哈希比对

### 2. 记住密码功能
- 添加"记住密码"选项（可选）
- 使用安全存储机制（如 Keychain）

### 3. 错误次数限制
- 限制密码输入错误次数（如3次）
- 超过次数后临时锁定账号

### 4. 双因素认证
- 结合邮箱或手机验证
- 增强账号安全性

---

**文档版本：** 1.0  
**创建日期：** 2024年  
**最后更新：** 2024年  
**维护人：** Development Team
